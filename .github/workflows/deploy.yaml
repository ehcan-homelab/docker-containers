name: Deploy
on:
  push:
    branches:
      - main
    paths:
      - '**.yml'
      - '**.yaml'

jobs:
  prepare_matrix:
    name: Prepare Matrix
    runs-on: ubuntu-slim
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for accurate changed files detection

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: |
            **.yml
            **.yaml

      - name: Set dynamic matrix
        id: set-matrix
        run: |
          CHANGED_FILES='${{ steps.changed-files.outputs.all_changed_and_modified_files }}'
          CHANGED_STACKS_ARRAY=()

          for file in $CHANGED_FILES; do
              # Check if the file is a root YAML file
              if [[ $file =~ ^([^/]+)\.yml$ ]]; then
                  stack_name="${BASH_REMATCH[1]}"
                  CHANGED_STACKS_ARRAY+=("$stack_name")
              # Check if the file is in a data/{{stack_name}} directory
              elif [[ $file =~ ^data/([^/]+)/ ]]; then
                  stack_name="${BASH_REMATCH[1]}"
                  CHANGED_STACKS_ARRAY+=("$stack_name")
              fi
          done
          CHANGED_STACKS=$(printf "%s " "${CHANGED_STACKS_ARRAY[@]}")
          CHANGED_STACKS="${CHANGED_STACKS% }"

          CONFIGS=$(cat _configs.json)

          FILTERED_CONFIGS=$(echo "$CONFIGS" | jq -c --arg changed_stacks "$CHANGED_STACKS" '
            [.[] |
                .stack_name as $stack_name |
                select(
                  ($changed_stacks | split(" ") | index($stack_name)) != null
                )
            ]
          ')

          if [ "$(echo "$FILTERED_CONFIGS" | jq 'length')" -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

          echo $FILTERED_CONFIGS
          echo "matrix=$(echo "$FILTERED_CONFIGS" | jq -c '{config: .}')" >> $GITHUB_OUTPUT

  deploy:
    needs: prepare_matrix
    if: needs.prepare_matrix.outputs.has_changes == 'true'
    name: Deploy (${{ matrix.config.stack_name }}, ${{ matrix.config.host }})
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.prepare_matrix.outputs.matrix) }}
      fail-fast: false

    env:
      REMOTE_HOST: ${{ matrix.config.host }}
      DOCKER_CONTEXT_HOST: ${{ matrix.config.docker_host }}
      DOCKER_CONTEXT_NAME: ${{ matrix.config.stack_name }}-ctx
      DOCKER_COMPOSE_FILE: ${{ matrix.config.stack_name }}.yml
      DOCKER_PROJECT_NAME: ${{ matrix.config.stack_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:github-actions

      - name: Set up Docker context
        run: |
          docker context \
            create ${{ env.DOCKER_CONTEXT_NAME }} \
            --docker host=${{ env.DOCKER_CONTEXT_HOST }}

      - name: Prepare 1Password env vars
        if: ${{ matrix.config.secrets }}
        run: |
          # Dump the secrets object provided by the matrix into a file and convert to entries
          echo '${{ toJson(matrix.config.secrets) }}' > /tmp/secrets.json
          # Iterate over key/value pairs and append them to GITHUB_ENV so the 1Password action can pick them up.
          for entry in $(jq -r 'to_entries[] | @base64' /tmp/secrets.json); do
            _jq() { echo "${entry}" | base64 --decode | jq -r "${1}"; }
            KEY=$(_jq '.key')
            VAL=$(_jq '.value')
            # Ensure values containing spaces or special chars are preserved
            echo "${KEY}=${VAL}" >> $GITHUB_ENV
          done

      - name: Load secret from 1Password
        if: ${{ matrix.config.secrets }}
        uses: 1password/load-secrets-action@v3
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      - name: Copy data files
        if: ${{ matrix.config.data }}
        run: |
          for item in $(echo '${{ toJson(matrix.config.data) }}' | jq -c '.[]'); do
            FROM=$(echo "$item" | jq -r '.from')
            TO=$(echo "$item" | jq -r '.to')
            scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
              -r "$FROM" ${{ secrets.SSH_USER }}@${{ env.REMOTE_HOST }}:"$TO"
          done

      - name: Deploy with Docker Compose
        run: |
          docker --context ${{ env.DOCKER_CONTEXT_NAME }} compose --file ${{ env.DOCKER_COMPOSE_FILE }} \
            --project-name ${{ env.DOCKER_PROJECT_NAME }} up -d --remove-orphans

      - name: Cleanup Docker context
        if: always()
        run: |
          docker context rm ${{ env.DOCKER_CONTEXT_NAME }} --force || true
