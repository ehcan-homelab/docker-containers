name: Deploy
on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy (${{ matrix.config.stack_name }}, ${{ matrix.config.host }})
    runs-on: self-hosted
    strategy:
      matrix:
        config:
          - { host: '10.10.0.102', stack_name: 'arr-stack' }
          - { host: '10.10.0.102', stack_name: 'portainer' }
          - { host: '10.10.0.102', stack_name: 'uptime-kuma' }
          - { host: '10.10.0.102', stack_name: 'n8n' }
          - { host: '10.10.0.102', stack_name: 'wallos' }
          - { host: '10.10.0.102', stack_name: 'homarr' }
          - { host: '10.10.0.102', stack_name: 'open-webui' }

          - { host: '10.10.0.102', stack_name: 'cadvisor' }
          - { host: '10.10.0.107', stack_name: 'cadvisor' }
          - { host: '10.10.0.108', stack_name: 'cadvisor' }

          - { host: '10.10.0.102', stack_name: 'watchtower', ntfy_title: 'Docker_102', ntfy_topic: 'ehcan-docker-PVBwxrR8Hm'}
          - { host: '10.10.0.107', stack_name: 'watchtower', ntfy_title: 'Traefik_107', ntfy_topic: 'ehcan-traefik-pVRanLAbLF'}
          - { host: '10.10.0.108', stack_name: 'watchtower', ntfy_title: 'Grafana_108', ntfy_topic: 'ehcan-grafana-vpSU2BdGnR'}

    env:
      DOCKER_HOST: tcp://${{ matrix.config.host }}:2375
      DOCKER_CONTEXT_NAME: ${{ matrix.config.stack_name }}-ctx
      DOCKER_COMPOSE_FILE: ${{ matrix.config.stack_name }}.yml
      DOCKER_PROJECT_NAME: ${{ matrix.config.stack_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Ensure we fetch the previous commit to check for changes

      - name: Check if stack YAML file has changed
        id: check-changes
        run: |
          if git diff --name-only HEAD^ HEAD | grep -q "^${{ env.DOCKER_COMPOSE_FILE }}$"; then
            echo "Changes detected in ${{ env.DOCKER_COMPOSE_FILE }}"
          else
            echo "No changes in ${{ env.DOCKER_COMPOSE_FILE }}, skipping deployment."
            exit 0
          fi

      - name: Set up Docker context
        run: |
          docker context \
            create ${{ env.DOCKER_CONTEXT_NAME }} \
            --docker host=${{ env.DOCKER_HOST }}

      - name: Inject secrets (arr-stack)
        if: env.DOCKER_PROJECT_NAME == 'arr-stack'
        run: |
          echo "${{ secrets.ARR_CIFS }}" >> $GITHUB_ENV
      - name: Inject secrets (firefox-vpn)
        if: env.DOCKER_PROJECT_NAME == 'firefox-vpn'
        run: |
          echo "${{ secrets.GLUETUN_SECRETS }}" > gluetun_secrets.env
      - name: Inject Watchtower configs
        if: env.DOCKER_PROJECT_NAME == 'watchtower'
        run: |
          echo "NTFY_TITLE=${{ matrix.config.ntfy_title }}" >> $GITHUB_ENV
          echo "NTFY_TOPIC=${{ matrix.config.ntfy_topic }}" >> $GITHUB_ENV
      - name: Inject secrets (open-webui)
        if: env.DOCKER_PROJECT_NAME == 'open-webui'
        run: |
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" > .env
          echo "WEBUI_SECRET_KEY=${{ secrets.OPEN_WEBUI_SECRET_KEY }}" > .env

      - name: Deploy with Docker Compose
        run: |
          docker --context ${{ env.DOCKER_CONTEXT_NAME }} compose --file ${{ env.DOCKER_COMPOSE_FILE }} pull
          docker --context ${{ env.DOCKER_CONTEXT_NAME }} compose --file ${{ env.DOCKER_COMPOSE_FILE }} \
            --project-name ${{ env.DOCKER_PROJECT_NAME }} up -d --remove-orphans

      - name: Cleanup Docker context
        if: always()
        run: |
          docker context rm ${{ env.DOCKER_CONTEXT_NAME }} --force
