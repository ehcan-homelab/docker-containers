name: Deploy
on:
  push:
    branches:
      - main
    paths:
      - '**.yml'
      - '**.yaml'

jobs:
  prepare_matrix:
    name: Prepare Matrix
    runs-on: self-hosted
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for accurate changed files detection

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: |
            *.yml
            *.yaml

      - name: Set dynamic matrix
        id: set-matrix
        run: |
          CONFIGS=$(cat configs.json)
          CHANGED_FILES='${{ steps.changed-files.outputs.all_changed_and_modified_files }}'

          FILTERED_CONFIGS=$(echo "$CONFIGS" | jq -c --arg changed_files "$CHANGED_FILES" '
            [.[] |
                .stack_name as $stack_name |
                select(
                ($changed_files | split(" ") | index($stack_name + ".yml")) != null or
                ($changed_files | split(" ") | index($stack_name + ".yaml")) != null
                )
            ]
          ')

          # Check if we have any configurations to deploy
          if [ "$(echo "$FILTERED_CONFIGS" | jq 'length')" -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

          # Set the matrix output
          echo "matrix=$(echo "$FILTERED_CONFIGS" | jq -c '{config: .}')" >> $GITHUB_OUTPUT

  deploy:
    needs: prepare_matrix
    if: needs.prepare_matrix.outputs.has_changes == 'true'
    name: Deploy (${{ matrix.config.stack_name }}, ${{ matrix.config.host }})
    runs-on: self-hosted
    strategy:
      matrix: ${{ fromJson(needs.prepare_matrix.outputs.matrix) }}
      fail-fast: false

    env:
      DOCKER_HOST: tcp://${{ matrix.config.host }}:2375
      DOCKER_CONTEXT_NAME: ${{ matrix.config.stack_name }}-ctx
      DOCKER_COMPOSE_FILE: ${{ matrix.config.stack_name }}.yml
      DOCKER_PROJECT_NAME: ${{ matrix.config.stack_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker context
        run: |
          docker context \
            create ${{ env.DOCKER_CONTEXT_NAME }} \
            --docker host=${{ env.DOCKER_HOST }}

      - name: Inject secrets
        run: |
          case ${{ env.DOCKER_PROJECT_NAME }} in
            "arr-stack")
              echo "${{ secrets.ARR_CIFS }}" >> $GITHUB_ENV
              ;;
            "open-webui")
              echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
              echo "OPEN_WEBUI_SECRET_KEY=${{ secrets.OPEN_WEBUI_SECRET_KEY }}" >> $GITHUB_ENV
              echo "OPEN_ROUTER_API_KEY=${{ secrets.OPEN_ROUTER_API_KEY }}" >> $GITHUB_ENV
              echo "LITELLM_MASTER_KEY=${{ secrets.LITELLM_MASTER_KEY }}" >> $GITHUB_ENV
              echo "LITELLM_SALT_KEY=${{ secrets.LITELLM_SALT_KEY }}" >> $GITHUB_ENV
              ;;
            "watchtower")
              server="${{ matrix.config.server }}"
              case "$server" in
                "docker")
                  echo "DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN_DOCKER }}" >> $GITHUB_ENV
                  ;;
                "traefik")
                  echo "DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN_TRAEFIK }}" >> $GITHUB_ENV
                  ;;
                "grafana")
                  echo "DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN_GRAFANA }}" >> $GITHUB_ENV
                  ;;
              esac
              ;;
          esac

      - name: Deploy with Docker Compose
        run: |
          docker --context ${{ env.DOCKER_CONTEXT_NAME }} compose --file ${{ env.DOCKER_COMPOSE_FILE }} \
            --project-name ${{ env.DOCKER_PROJECT_NAME }} up -d --remove-orphans

      - name: Cleanup Docker context
        if: always()
        run: |
          docker context rm ${{ env.DOCKER_CONTEXT_NAME }} --force || true
